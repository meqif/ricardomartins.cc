<!DOCTYPE html>
<html lang="en">
<head>
	<meta http-equiv="Content-type" content="text/html; charset=utf-8"/>
	<title>Now with 70% less fat!</title>
	<link rel="me home" href="http://ricardomartins.cc/"/>
	<link rel="openid.server" href="http://www.myopenid.com/server"/>
	<link rel="openid.delegate" href="http://meqif.myopenid.com"/>
	<link rel="stylesheet" type="text/css" href="/css/reset.css"/>
	<link rel="stylesheet" type="text/css" href="/css/stylesheet.min.css"/>
	<link rel="alternate" type="application/atom+xml" title="Ricardo Martins' web place" href="/atom.xml"/>
	<meta name="author" content="Ricardo Martins" />
	<meta name="description" content="Ricardo Martins - Now with 70% less fat!" />
	<meta name="keywords" content="ricardo martins, portugal, computer science,computer scientist, software"/>
	<meta name="viewport" content="width=808" />
	<meta name="geo.placename" content="Caparica, Almada, Portugal" />
	<meta name="geo.position" content="38.668428;-9.190110" />
	<meta name="geo.region" content="PT-Setubal" />
	<meta name="ICBM" content="38.668428, -9.190110" />
	<meta name="DC.title" content="Ricardo Martins' online home"/>
	<!--
	<script type="text/javascript" src="http://use.typekit.com/fon1szy.js"></script>
	<script type="text/javascript">try{Typekit.load();}catch(e){}</script>
	-->
	<!--
	<link rel="stylesheet" href="http://static.tumblr.com/thpaaos/DIcklyl4z/reset.css" type="text/css">
	-->
	<style type="text/css">
	  body {
	    height: 100%;
	    color: #454545;
	/*
	    font-size: 14px;
	    line-height: 21px;
	*/
	    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
	    background: url('/images/bg.jpg');
		margin-right:auto;
		margin-left:auto;
	  }

	  a {
	    color: #238db1;
	    text-decoration: none;
	  }

	  *:active,*:focus { outline: 0px; }
	  a img { border-width: 0px; }

	/*
	  p {
	    margin: 0 0 14px 0;
	  }

	  #footer p {
		margin: 0;
	}

	#footer {
		padding-top: 15px;
	}
	*/

	p { font-size: 12px; }

	  em { font-style: italic; }
	  strong { font-weight: bold; }

	  blockquote {
	    border-left: 4px solid #EFEFEF;
	    margin: 0 0 14px 0;
	    padding: 0 0 0 15px;
	  }

	  h2 { font-size: 22px }
	h3 { font-size: 20px }
	/* h2, h3 { font-weight: bold; margin-bottom: 15px; margin-top: 35px; } */
	pre.prettyprint { font-size: 0.9em; margin-left: 15px; margin-bottom: 10px; padding: 15px; background: #FCFCFC; border: 1px solid #eee }
	  </style>
</head>
<body>

<div id="top"></div>
<div id="page-wrapper">

	<div id="header">
	<div id="site-title">
		<h1>
			<a href="/">Ricardo Martins</a>
			<span class="blurb">on software and madness</span>
		</h1>
	</div>
	<div id="navlist-wrapper">
		<ul id="navlist">
			<li><a href="/">archive</a></li>
			<li><a href="/">about</a></li>
		</ul>
	</div>
	</div>

	

	<div id="contents">
<h2>Now with 70% less fat!</h2>
<span class="post-topics"><a href="#disqus_thread">comments</a> [ optimisation  webdev  ]</span>
<span class="blurb">11 August 2009</span>
<br/>
<script type="text/javascript">
	tweetmeme_service = 'bit.ly';
	tweetmeme_source = 'meqif';
</script>
<div id="tweetmeme"><p><script type="text/javascript" src="http://tweetmeme.com/i/scripts/button.js"></script></p></div>
<p>For the last few days, I&#8217;ve been optimising this blog in order to have it load faster. Why? A site that loads fast is a good site.</p>
<p>One of the most obvious things would be compressing the content sent to the client/browser. For somewhat obvious reasons, <a href="http://www.nearlyfreespeech.net">NearlyFreeSpeech</a> didn&#8217;t enable the gzip module on Apache nor does allow one to enable it in <code>.htaccess</code>.</p>
<p>After a few digging in the <abbr title="NearlyFreeSpeech"><span class="caps">NFS</span></abbr> forums, I came to the conclusion that I had two options: either using MultiViews or a RewriteRule in my <code>.htaccess</code>. Since the MultiViews needed some more work, I opted for the following rewrite rules:</p>
<pre class='prettyprint'>Header add Vary accept-encoding 
RewriteEngine on 
RewriteCond %{HTTP:accept-encoding} gzip 
RewriteCond %{REQUEST_FILENAME} !\.gz$ 
RewriteCond %{REQUEST_FILENAME}.gz -f 
RewriteRule (.*) $1.gz [L]</pre>
<p>Translated to plain English, this checks whether the requested file isn&#8217;t already a <code>.gz</code> file and if there&#8217;s a gzipped version of the requested file in the server. If so, the gzipped version is sent to the browser instead. This allowed to reduce in more than half the size of most files (html, css and js).</p>
<p>The next step was &#8220;smushing&#8221; the images, that is, compressing them further. There&#8217;s a service (<a href="http://smush.it">Smush.it</a>) that tries several techniques to compress images without changing the image quality. This shaved a few more KB.</p>
<p>However, that wasn&#8217;t enough for me. I needed more. This was becoming almost an addiction, trying to make my blog so light it loaded instantly.</p>
<p>So I used another cool service (<a href="http://compressorrater.thruhere.net/">CompressorRater</a>) to try several minification techniques on Javascript code in order to squeeze some more KB. Success!</p>
<p>I still had too many <span class="caps">HTTP</span> requests going on. Each <span class="caps">HTTP</span> request adds some loading time to the total. Since I was using three stylesheets (one for <a href="http://meyerweb.com/eric/tools/css/reset/">resetting the <span class="caps">CSS</span> styles</a>, another for the code syntax highlighter and one for the blog stylesheet itself), I first tried merging them all into one file. That had disastrous results and I&#8217;m still not exactly sure why.<br />
&#8220;Alright&#8221;, I thought, &#8220;I&#8217;ll just leave the reset <span class="caps">CSS</span> alone and merge the other two.&#8221; It worked fine. Then I minified it, which shaved about half the original size.</p>
<p>At this point, there wasn&#8217;t much more I could do. The bottleneck now was loading the comments from Disqus. But there was one thing bugging me: the code for updating the comment count was running in every page, even in the index/archive, where there was no need. That introduced some delay in a completely static page.<br />
It turns out the code the guys at Disqus tell you to use do something silly for a reason I cannot understand: after checking for thread/blog post links, it contacts the Disqus servers to get the comment count <em>even if finds no such links</em>!</p>
<p>So, I changed it to the following:</p>
<pre class='prettyprint'>(function() {
  var links = document.getElementsByTagName('a');
  var query = '?';
  for(var i = 0; i &lt; links.length; i++) {
    if(links[i].href.indexOf('#disqus_thread') &gt;= 0) {
      query += 'url' + i + '=' + encodeURIComponent(links[i].href) + '&amp;';
      document.write('&lt;script type="text/javascript" src="http://disqus.com/forums/scarybox/get_num_replies.js' + query + '"&gt;&lt;/' + 'script&gt;');
    }
  }
})();</pre>
<p>This fixed the problem without seemingly affecting the script&#8217;s behaviour.</p>
<p>I also updated the link to jQuery, from version 1.2.6 to 1.3.2. The new version is 3KB bigger but it&#8217;s also much faster than the pre-1.3 versions. For instance, the &#8220;About&#8221; slider on the top of this blog now slides up and down much smoother. All in all, it was worth the extra 3KB, since I removed much more in my little adventure with compressing stuff.</p>
<p>Now the slowest part of my site is loading the Disqus comments, and I have no idea how to speed that up. Any suggestions?</p>
</div>

<div id="comments">
	<div id="disqus_thread"></div>
	<script type="text/javascript" src="http://disqus.com/forums/scarybox/embed.js"></script>
	<noscript><a href="http://scarybox.disqus.com/?url=ref">View the discussion thread.</a></noscript>
</div>



	<div id="footer">
		<div id="contact">
			<p>
				<img style="float: left; margin-top: 0.5em; margin-right: 0.5em;" alt="" src="/images/redmage.png"/>
				Ricardo Martins
				<br />
				Computer Science Student
				<br />
				<a href="http://mailhide.recaptcha.net/d?k=01N86GeETDl_T3BFfSz_bhIg==&amp;c=sMQk9aPiKnri8XU2hStEeVu0OCs52lMb5p7eQnIJB40=" id="email" rel="me email">Email me!</a>
			</p>
		</div>
		<div id="rss">
			<p>
				<a href="/atom.xml"><img src="/images/feed_icon.png" width="64" height="64" alt="Atom Feed" title="Atom Feed"/></a>
			</p>
		</div>
	</div>
</div>


<script type="text/javascript">
(function() {
		var links = document.getElementsByTagName('a');
		var query = '?';
		for(var i = 0; i < links.length; i++) {
			if(links[i].href.indexOf('#disqus_thread') >= 0) {
				query += 'url' + i + '=' + encodeURIComponent(links[i].href) + '&';
				document.write('<script type="text/javascript" src="http://disqus.com/forums/scarybox/get_num_replies.js' + query + '"></' + 'script>');
			}
		}
	})();
</script>

<script type="text/javascript" src="/js/prettify.min.js"></script>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
<script type="text/javascript" src="/js/misc.min.js"></script>

<!-- Woopra Code Start -->
<script type="text/javascript" src="//static.woopra.com/js/woopra.v2.js"></script>
<script type="text/javascript">
woopraTracker.track();
</script>
<!-- Woopra Code End -->

<script type="text/javascript">
var domainy = location.protocol == "https:" ? "https://static.getclicky.com" : "http://static.getclicky.com";
document.write(unescape("%3Cscript src='" + domainy + "/124525.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<noscript><p><img alt="Clicky" width="1" height="1" src="http://static.getclicky.com/124525-db16.gif" /></p></noscript>

</body>
</html>
